# Prek - Pre-commit Configuration

This project uses [prek](https://prek.j178.dev/), an ultra-fast pre-commit implementation written in Rust.

## Installation

Hooks are automatically installed during `make setup`. For manual installation:

```bash
uv run prek install
```

## Useful Commands

### Run all hooks

```bash
# On all files
uv run prek run --all-files

# On modified files only
uv run prek run
```

### Run a specific hook

```bash
# List all available hooks
uv run prek list

# Run a specific hook
uv run prek run ruff
uv run prek run ty-check
uv run prek run eslint-next
```

### Run multiple hooks

```bash
uv run prek run ruff ruff-format ty-check
```

### Run on a specific directory

```bash
# Only files in apps/server
uv run prek run --directory apps/server
```

### Skip hooks temporarily

```bash
# Skip one or more hooks
PREK_SKIP=ty-check,eslint-next git commit -m "WIP"

# Bypass all hooks (avoid this)
git commit --no-verify -m "emergency fix"
```

### Update hooks

```bash
# Update all hooks to their latest version
uv run prek auto-update

# With a safety delay (recommended to avoid supply chain attacks)
uv run prek auto-update --cooldown-days 7
```

## Configured Hooks

### Built-in (Native Rust - Ultra Fast)

- `trailing-whitespace` - Removes trailing whitespace
- `end-of-file-fixer` - Adds empty line at end of file
- `check-yaml` - Validates YAML files
- `check-json` - Validates JSON files
- `check-toml` - Validates TOML files
- `check-added-large-files` - Prevents adding files > 1MB
- `check-merge-conflict` - Detects git conflict markers
- `detect-private-key` - Detects private keys
- `check-case-conflict` - Detects case conflicts (case-insensitive on macOS)
- `mixed-line-ending` - Normalizes line endings (LF)

### Python (Backend - apps/server)

- `ruff` - Python linting (replaces flake8, isort, etc.)
- `ruff-format` - Python formatting (replaces black)
- `ty-check` - Python type checking (ultra fast)

### JavaScript/TypeScript (Frontend)

- `eslint-next` - Next.js linting (apps/next)
- `eslint-vue` - Vue.js linting (apps/vue)

### Docker

- `hadolint-docker` - Dockerfile linting

### Documentation

- `python-check-blanket-noqa` - Checks noqa without error code
- `python-check-blanket-type-ignore` - Checks type:ignore without code

## Priorities and Parallelism

Hooks are organized by priority:

- **Priority 0**: Fast hooks (built-in) - run in parallel
- **Priority 10**: Lint & format (Python, JS, Docker) - run in parallel
- **Priority 20**: Type checking (ty) - runs after linting

Hooks with the same priority run in parallel (up to `N_CPU` threads).

## Debugging

```bash
# Disable fast path (use original implementations)
PREK_NO_FAST_PATH=1 uv run prek run

# Disable parallelism
PREK_NO_CONCURRENCY=1 uv run prek run

# Verbose mode
uv run prek run -v
```

## CI Integration

Hooks are also run in GitHub Actions (see `.github/workflows/lint.yml`).

## Resources

- Official documentation: https://prek.j178.dev/
- Repository: https://github.com/j178/prek
- Configuration: [.pre-commit-config.yaml](.pre-commit-config.yaml)
